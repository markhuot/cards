function closest(e,t){for(;e&&(!e.classList||!e.classList.contains(t));)e=e.parentNode;return e}function indexOfNode(e,t){var r=0;for(e=e.previousSibling;e;)e.nodeType!=Node.TEXT_NODE&&r++,e=e.previousSibling;return r}function serialize(e,t){var r=[];for(var a in e)if(e.hasOwnProperty(a)){var o=t?t+"["+a+"]":a,d=e[a];r.push("object"==typeof d?serialize(d,o):encodeURIComponent(o)+"="+encodeURIComponent(d))}return r.join("&")}function offset(e){for(var t=e.offsetTop,r=e.offsetLeft;e.parentNode;)t-=e.scrollTop,r-=e.scrollLeft,e=e.parentNode;return{top:t,left:r}}function xhrPost(e,t){var r=new XMLHttpRequest;r.open("POST",e,!0),r.setRequestHeader("X-CSRF-TOKEN",csrfToken),r.setRequestHeader("Content-type","application/x-www-form-urlencoded; charset=UTF-8"),r.onreadystatechange=function(){4!=r.readyState||200!=r.status},r.send(serialize(t))}function dragEnd(e){for(var t=0,r=activeClicks.length;t<r;t++)clearTimeout(activeClicks[t]);if(dragging!==!1){e.preventDefault();var a={card:{},stack:[]},o=document.getElementById("drag-placeholder");if(o){o.parentNode.removeChild(o),targetStack.children[targetIndex]?targetStack.insertBefore(dragging.parentNode,targetStack.children[targetIndex]):targetIndex>=targetStack.children.length&&targetStack.appendChild(dragging.parentNode),targetStack.dataset.stackAttributes&&(a.card.from=JSON.parse(sourceStack.dataset.stackAttributes),a.card.to=JSON.parse(targetStack.dataset.stackAttributes));for(var d=targetStack.querySelectorAll(".card"),t=0,r=d.length;t<r;t++){var n=d[t],c=indexOfNode(n.parentNode,!0);a.stack.push({card_id:n.dataset.cardId,order:c})}xhrPost("/cards/"+dragging.dataset.cardId+"/move",a)}dragging.classList.remove("dragging"),proxy.parentNode.removeChild(proxy),dragging=!1,proxy=!1}}function insertPlaceholder(e,t){targetStack=e,targetIndex=t;for(var r=e.offsetLeft,a=e;a.parentNode;)r-=a.scrollLeft,a=a.parentNode;var o=document.getElementById("drag-placeholder");o||(o=document.createElement("div"),o.id="drag-placeholder",document.body.appendChild(o)),e.children[t]?(o.style.top=e.children[t].offsetTop-e.scrollTop-5,o.style.left=r,o.style.width=e.children[t].offsetWidth):t>0&&t>=e.children.length?(o.style.top=e.children[e.children.length-1].offsetTop-e.scrollTop+e.children[e.children.length-1].offsetHeight+5,o.style.left=r,o.style.width=e.children[e.children.length-1].offsetWidth):0==t&&(o.style.top=e.offsetTop+e.offsetHeight,o.style.left=r,o.style.width=e.offsetWidth)}var csrfToken=document.getElementById("csrf-token").getAttribute("content"),activeClicks=[],dragging=!1,proxy=!1,cards=[],stacks=[],sourceStack=!1,targetStack=!1,targetIndex=!1;document.body.addEventListener("dragstart",function(e){e.preventDefault()}),document.body.addEventListener("mousedown",function(e){var t=closest(e.target,"card");t&&activeClicks.push(setTimeout(function(){dragging=t,dragging.classList.add("dragging"),proxy=document.createElement("div"),proxy.setAttribute("id","drag-proxy"),proxy.innerHTML="#<strong>"+t.dataset.localId+"</strong>",document.body.appendChild(proxy),sourceStack=closest(t,"card-stack"),cards=document.querySelectorAll(".card"),stacks=document.querySelectorAll(".stack")},100))}),document.body.addEventListener("mouseup",dragEnd),document.body.addEventListener("click",dragEnd),document.body.addEventListener("mousemove",function(e){if(dragging){var t=!1,r=e.pageX,a=e.pageY;proxy.style.left=r,proxy.style.top=a;for(var o=0,d=cards.length;o<d;o++){var n=cards[o],c=closest(n,"card-stack"),s=offset(n).top,i=offset(n).left;if(r>i&&r<i+n.offsetWidth&&a>s&&a<s+n.offsetHeight){var l=indexOfNode(n.parentNode);a>s+n.offsetHeight/2&&(l+=1),insertPlaceholder(c,l),t=!0;break}}if(!t)for(o=0,d=stacks.length;o<d;o++){var f=stacks[o],g=offset(f).top,p=offset(f).left,c=f.querySelectorAll(".card-stack")[0];if(r>p&&r<p+f.offsetWidth&&a>g&&a<g+f.offsetHeight&&a>c.offsetTop+c.offsetHeight){insertPlaceholder(c,c.querySelectorAll(".card").length),t=!0;break}}}}),document.body.addEventListener("click",function(e){if("line"==e.target.getAttribute("name")){var t=e.target.getAttribute("value"),r=closest(e.target,"card-detail__description"),a="/cards/";r||(r=closest(e.target,"comment-detail"),a="/comments/"),a+=r.dataset.id+"/check",xhrPost(a,{line:t,value:e.target.checked?1:0})}});