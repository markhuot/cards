function closest(e,t){for(;e&&(!e.classList||!e.classList.contains(t));)e=e.parentNode;return e}function indexOfNode(e,t){var r=0;for(e=e.previousSibling;e;)e.nodeType!=Node.TEXT_NODE&&r++,e=e.previousSibling;return r}function serialize(e,t){var r=[];for(var o in e)if(e.hasOwnProperty(o)){var d=t?t+"["+o+"]":o,a=e[o];r.push("object"==typeof a?serialize(a,d):encodeURIComponent(d)+"="+encodeURIComponent(a))}return r.join("&")}function xhrPost(e,t){var r=new XMLHttpRequest;r.open("POST",e,!0),r.setRequestHeader("X-CSRF-TOKEN",csrfToken),r.setRequestHeader("Content-type","application/x-www-form-urlencoded; charset=UTF-8"),r.onreadystatechange=function(){4!=r.readyState||200!=r.status},r.send(serialize(t))}function dragEnd(e){for(var t=0,r=activeClicks.length;t<r;t++)clearTimeout(activeClicks[t]);if(dragging!==!1){e.preventDefault();var o={card:{},stack:[]},d=document.getElementById("drag-placeholder");if(d){d.parentNode.removeChild(d),targetStack.children[targetIndex]?targetStack.insertBefore(dragging.parentNode,targetStack.children[targetIndex]):targetIndex>=targetStack.children.length&&targetStack.appendChild(dragging.parentNode);var a=closest(targetStack,"stack");o.card.stack_id=a.dataset.stackId;for(var n=a.querySelectorAll(".card"),t=0,r=n.length;t<r;t++){var s=n[t],c=indexOfNode(s.parentNode,!0);o.stack.push({card_id:s.dataset.cardId,order:c})}xhrPost("/cards/"+dragging.dataset.cardId+"/move",o)}dragging.classList.remove("dragging"),proxy.parentNode.removeChild(proxy),dragging=!1,proxy=!1}}function insertPlaceholder(e,t){targetStack=e,targetIndex=t;var r=document.getElementById("drag-placeholder");r||(r=document.createElement("div"),r.id="drag-placeholder",document.body.appendChild(r)),e.children[t]?(r.style.top=e.children[t].offsetTop-e.scrollTop-5,r.style.left=e.children[t].offsetLeft,r.style.width=e.children[t].offsetWidth):t>0&&t>=e.children.length?(r.style.top=e.children[e.children.length-1].offsetTop-e.scrollTop+e.children[e.children.length-1].offsetHeight+5,r.style.left=e.children[e.children.length-1].offsetLeft,r.style.width=e.children[e.children.length-1].offsetWidth):0==t&&(r.style.top=e.offsetTop+e.offsetHeight,r.style.left=e.offsetLeft,r.style.width=e.offsetWidth)}var csrfToken=document.getElementById("csrf-token").getAttribute("content"),activeClicks=[],dragging=!1,proxy=!1,cards=[],stacks=[],targetStack=!1,targetIndex=!1;document.body.addEventListener("dragstart",function(e){e.preventDefault()}),document.body.addEventListener("mousedown",function(e){var t=closest(e.target,"card");t&&activeClicks.push(setTimeout(function(){dragging=t,dragging.classList.add("dragging"),proxy=document.createElement("div"),proxy.setAttribute("id","drag-proxy"),proxy.innerHTML="#<strong>"+t.dataset.localId+"</strong>",document.body.appendChild(proxy),cards=document.querySelectorAll(".card"),stacks=document.querySelectorAll(".stack")},100))}),document.body.addEventListener("mouseup",dragEnd),document.body.addEventListener("click",dragEnd),document.body.addEventListener("mousemove",function(e){if(dragging){var t=!1,r=e.pageX,o=e.pageY;proxy.style.left=r,proxy.style.top=o;for(var d=0,a=cards.length;d<a;d++){var n=cards[d],s=closest(n,"card-stack");if(r>n.offsetLeft&&r<n.offsetLeft+n.offsetWidth&&o>n.offsetTop-s.scrollTop&&o<n.offsetTop-s.scrollTop+n.offsetHeight){var c=indexOfNode(n.parentNode);o>n.offsetTop-s.scrollTop+n.offsetHeight/2&&(c+=1),console.debug(n.dataset.cardId,c),insertPlaceholder(s,c),t=!0;break}}if(!t)for(d=0,a=stacks.length;d<a;d++){var i=stacks[d],s=i.querySelectorAll(".card-stack")[0];if(r>i.offsetLeft&&r<i.offsetLeft+i.offsetWidth&&o>i.offsetTop&&o<i.offsetTop+i.offsetHeight&&o>s.offsetTop+s.offsetHeight){insertPlaceholder(s,s.querySelectorAll(".card").length),t=!0;break}}}}),document.body.addEventListener("click",function(e){if("line"==e.target.getAttribute("name")){var t=e.target.getAttribute("value"),r=closest(e.target,"card-detail__description"),o="/cards/";r||(r=closest(e.target,"comment-detail"),o="/comments/"),o+=r.dataset.id+"/check",xhrPost(o,{line:t,value:e.target.checked?1:0})}});